language: python
sudo: required
dist: bionic
python: 3.6
git:
  depth: false
branches:
  except:
    - /^untagged/
    - /\.dev[0-9]+$/
virtualenv:
  system_site_packages: true
before_install:
- git config remote.origin.fetch +refs/heads/*:refs/remotes/origin/*
- git fetch --tags
- sudo apt-get -qq update
- |
  sudo apt-get install -y \
      rpm fakeroot jq python-all python3-all python-setuptools python3-setuptools debhelper \
      python-git python-semver python-jinja2 python3-git python3-semver python3-jinja2
install:
- pip install -r requirements_test.txt
- pip3 install -r requirements_test.txt
script:
- export VERSION=${TRAVIS_TAG:-$(<version.txt).dev${TRAVIS_BUILD_NUMBER}}
- python setup.py test bdist_wheel
- pip install dist/gcg-*.whl
- gcg -O deb -n gcg -D unstable -c "${VERSION}" -o debian/changelog
- sed -e  's/^$/./' -e 's/^/ /' LICENSE >> debian/copyright
- python setup.py sdist
- mkdir -p deb_dist
- tar xzCf deb_dist dist/gcg-${VERSION}.tar.gz
- pushd deb_dist/gcg-${VERSION} && dpkg-source -b . && popd
- |
  if test "${BUILD_BIN_PKGS}" = "yes" ; then
    pushd deb_dist/gcg-${VERSION} && dpkg-buildpackage -A --no-sign && popd
  fi
- sed -e "s/_VERSION_/${VERSION}/g" < gcg.spec.in > gcg.spec
- gcg -O rpm >> gcg.spec
- cp .rpmmacros ~/
- rpmbuild -bs gcg.spec --nodeps --with python3 --define "_topdir ${PWD}/rpm_dist" --define "_sourcedir ${PWD}/dist"
- test "${BUILD_BIN_PKGS}" = "yes" && bt=b || bt=s
- rpmbuild -b${bt} gcg.spec --nodeps --with python3 --define "_topdir ${PWD}/rpm_dist" --define "_sourcedir ${PWD}/dist"
- rpm -qlpi --requires --verbose rpm_dist/RPMS/*/*.rpm rpm_dist/SRPMS/*.rpm
before_deploy:
- ls -al ; pwd
- find dist -ls
- find deb_dist -ls
- find rpm_dist -ls
- |
  if [[ -n "$TRAVIS_TAG" ]] && [[ "${TRAVIS_TAG}" != "$(<version.txt)" ]]; then
      >&2 echo "ERROR: You have marked a release by applying a Git tag and your version.txt doesn't match it"
      >&2 echo "Tip: Don't tag if you want to deploy only to test.pypi.org"
      false
  fi
before_deploy:
- ls -al; pwd; find dist deb_dist -ls
- >
    if [[ -n "$TRAVIS_TAG" ]] && [[ "${TRAVIS_TAG}" != "$(<version.txt)" ]]; then
        >&2 echo "ERROR: You have marked a release by applying a Git tag and your version.txt doesn't match it"
        >&2 echo "Tip: Don't tag if you want to deploy only to test.pypi.org"
        false
    fi
- cp -v pypirc ~/.pypirc && cat ~/.pypirc
- if [[ $VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then component=main; lifecycle=stable; fi


deploy:
- provider: script
  skip_cleanup: true
  script: twine upload -p "${PYPI_PASS}" -r pypi "dist/gcg-${VERSION}.tar.gz" "dist/gcg-${VERSION}"-*.whl
  on:
    tags: true
    repo: nokia/git-changelog-generator
- provider: script
  skip_cleanup: true
  script: twine upload -p "${PYPI_PASS}" -r testpypi "dist/gcg-${VERSION}.tar.gz" "dist/gcg-${VERSION}"-*.whl
  on:
    tags: false
    all_branches: true
    repo: nokia/git-changelog-generator
- provider: script
  skip_cleanup: true
  script: >
            bash scripts/bintray/deploy.bash -u "$BINTRAY_USER"
            -p "$BINTRAY_KEY" -v "$(< version.txt)"
            -r ${lifecycle:-${DEFAULT_RPM_LIFECYCLE}}
            -c ${component:-${DEFAULT_DEB_COMPONENT}} -d
  on:
    tags: true
    repo: nokia/git-changelog-generator

env:
  global:
  - BINTRAY_USER=weakcamel
  - PYPI_USER=weakcamel
  # BINTRAY_KEY
  - secure: TWZFc2T8P48U4kdk2jksos4tCoN0nHSY2sac6YicyX0EAAKl1ZpLcl0Q126Z5WLXYvXTgooqRq7DK8unIaTsttBVqzYQf2UkfOeGS04ORAIp6ohRfbPmTLjccsbkb6zVjYHRnrwyA3HtsegXQAIpjRqDSGLvAycTRvl2HO0Yci52ZlY0ONGlmIdyG3k5EGiPaQ0tP30MVhZdhyvH/UVywGu6tSlI6X5z9Cw/O/pnNWOb+1uUTxQTEM5vsdhJk5JiMl1IUIkijPYkxPEalLWR9VdpciwfGucWFqxHZaAh9xslhn9Sc2mZiG0pFITlbJ9qoT5JIGRcxjpZfvlV9c1dFErzTeaZm7BjN71vU36iP0aopUVZI7mQNDeTywFAbfRU3mnlfPmuia6aEZB1cQdr38DrsCa4kmWzRh44id3J3Y3KMcuoUNQsudVQs0mx0PfRYrfcXB42irl1tuBFK8Is89Gaajka1eUN2YbveoAp4pKnBv9CJ2fUdXJMkJHOSuq7HUPmdS+OVUXQA3XOuSVS1Bhkt4xJCpqDTMV4JUVitglmSNtqrHSNFJCqyNwvEK0ZN4dYwMEAWNYc38qT6z0Ydtf0Aix3+4FERoSakfVccvb/PhIHHivxxx1ODS3soq12N8wrBs2dTGbTnZugrXZ2DPYpfdDUsxAlDGoB5rplZ8Y=
  # PYPI_PASS
  - secure: VBtSEaK399NxRj3hBhLM11SSsz+orMYe9F4AMw2LTUq548et0+4pMcv+DewNaihye43jtZYBA09ZZMREFTLBgN74Nu+vf/RAwBNHkUAZOAIwKk6MrqaLwjXkoB6n/5fKX9/5VweztJHpVY4zppmz+P2AFa8XDpLyYZQ553P1Mm60Sl/W+mpTs5/L0yVv+Rpe2ATww679CuLQvvwMEc9HS4cmCH38IaMa9z3J5BiXVHAbzJndiUGvFABcewgHNgYAI2z5xOwzIkr7YsgAb/3bXrGp4DXhf2436NZIqu7bi6VJMIRDkgh5eFwJ8bLpMXQxO6G90o48E2otbapu6OUTsODSMYKbVtWJmK8y29GSnLcAuIrimuYFBQ/n8sFWykpRkNgfvMtpxYGl+QD14/2aKtCmayjLeoqC/0+dZmKGZJPSzq1nGN4mrPsbXj2EWrepb9xX8JRf15Rx3OeugfrtTA+2qiqpAEPXyrAouWBEitCjTtIwAdnzcOA4qQGFq2OjGxQvZBjuYUFxj/L8JH1vWROZw9d5r3zhiT30SxvSB25MwLKIZ4E0yXrHq2vxLIgMa1K8gIpv9V/7A7kR8piQWVIgplrurrg3PBydCNlOMZwL99HHiebvFBN+EdYX/if2a/oScHwMCaOPeBUlwZ1mz3alLgqf/PJAQkphVJxnNVU=
  - DEFAULT_DEB_COMPONENT=dev
  - DEFAULT_RPM_LIFECYCLE=dev
